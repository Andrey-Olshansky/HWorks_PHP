<?php
    /*–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫ –∑–∞–Ω—è—Ç–∏—é ¬´7_–§–∞–π–ª—ã, html —Ñ–æ—Ä–º—ã¬ª
    http://localhost/HWorks_PHP/Hw_7_Forms.php 
    –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
    1. cd C:\localhost\HWorks_PHP 
    2. php Hw_7_Forms.php
    */
?>
<?php
/*–ó–∞–¥–∞–Ω–∏–µ 2: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML-—Ñ–æ—Ä–º—É –æ—Ç 12.12.25
  –û–ø–∏—Å–∞–Ω–∏–µ
–ó–∞–¥–∞—á–∞ ‚Äî –ø–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–æ—Ä–º–∞–º–∏, –ø–æ–Ω—è—Ç—å –æ—Ç–ª–∏—á–∏–µ GET –∏ POST 
–∑–∞–ø—Ä–æ—Å–æ–≤. 
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ
1. –°–æ–∑–¥–∞–π—Ç–µ HTML-—Ñ–∞–π–ª —Å —Ñ–æ—Ä–º–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è:
    1.1. file_name —Å –ø–æ–¥–ø–∏—Å—å—é ¬´—Å –∫–∞–∫–∏–º –∏–º–µ–Ω–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ¬ª 
    (—Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ);
    1.2. content —Å –ø–æ–¥–ø–∏—Å—å—é ¬´–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª¬ª (–ø–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞);
2. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∞—Ç—Ä–∏–±—É—Ç—ã enctype –∏ method —É —Ñ–æ—Ä–º—ã.
3. –°–æ–∑–¥–∞–π—Ç–µ PHP-—Ñ–∞–π–ª Hw_7_Forms.php, –∏–º—è –∫–æ—Ç–æ—Ä–æ–≥–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–æ –≤ –∞—Ç—Ä–∏–±—É—Ç–µ 
    —Ñ–æ—Ä–º—ã action.
4. –í–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ Hw_7_Forms.php –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
    4.1 –µ—Å–ª–∏ –ø–æ–ª–µ file_name –ø—É—Å—Ç–æ–µ, —Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ñ–æ—Ä–º—É, 
    –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é header –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è;
    4.2. –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —Ç–æ —Ç–æ–∂–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ 
    –Ω–∞ —Ñ–æ—Ä–º—É;
    4.3. –∏–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥ upload, –∏—Å–ø–æ–ª—å–∑—É—è –∏–º—è –∏–∑ 
    –ø–æ–ª—è file_name –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É 
    –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞.

–ü—Ä–æ–≤–µ—Ä–∫–∞:
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –≤ –ø–∞–ø–∫–µ HWorks_PHP:
    cd HWorks_PHP
    php -S localhost:8000
–û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:8000/index.html
  */
?>


<?php
    // –í–ö–õ–Æ–ß–ê–ï–ú –ë–£–§–ï–†–ò–ó–ê–¶–ò–Æ –°–ê–ú–û–ô –ü–ï–†–í–û–ô –°–¢–†–û–ö–û–ô
    ob_start();

    // ==================== –ñ–Å–°–¢–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ö–û–î–ò–†–û–í–ö–ò ====================
    header('Content-Type: text/html; charset=UTF-8');
    ini_set('default_charset', 'UTF-8');

    // ==================== –ü–†–û–í–ï–†–ö–ê ‚Ññ1: –ú–ï–¢–û–î –ó–ê–ü–†–û–°–ê ====================
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–æ–¥–æ–º POST
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        // –ï—Å–ª–∏ –Ω–µ—Ç - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ñ–æ—Ä–º—É
        header('Location: index.html');
        ob_end_flush();
        exit;
    }

    // ==================== –ü–†–û–í–ï–†–ö–ê ‚Ññ2: –ü–û–õ–ï file_name ====================
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –∏–º—è —Ñ–∞–π–ª–∞
    if (empty($_POST['file_name'])) {
        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ñ–æ—Ä–º—É
        header('Location: index.html');
        ob_end_flush();
        exit;
    }

    // ==================== –ü–†–û–í–ï–†–ö–ê ‚Ññ3: –§–ê–ô–õ –ó–ê–ì–†–£–ñ–ï–ù ====================
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫
    // UPLOAD_ERR_OK = 0 (—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω)
    if (!isset($_FILES['content']) || $_FILES['content']['error'] !== UPLOAD_ERR_OK) {
        // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ñ–æ—Ä–º—É
        header('Location: index.html');
        ob_end_flush();
        exit;
    }

    // ==================== –ü–û–î–ì–û–¢–û–í–ö–ê –ü–ê–ü–ö–ò –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò ====================
    $upload_dir = 'upload/'; // –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

    // –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!is_dir($upload_dir)) {
        mkdir($upload_dir, 0777, true);
    }

    // ==================== –ë–ï–ó–û–ü–ê–°–ù–û–ï –ò–ú–Ø –§–ê–ô–õ–ê ====================
    // 1. –ë–µ—Ä–µ–º –∏–º—è –∏–∑ —Ñ–æ—Ä–º—ã
    // 2. basename() –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç path traversal –∞—Ç–∞–∫
    // 3. preg_replace –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    $original_name = $_POST['file_name'];
    $safe_name = preg_replace('/[^\w\.-]/', '', basename($original_name));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∏–º—è –Ω–µ —Å—Ç–∞–ª–æ –ø—É—Å—Ç—ã–º
    if (empty($safe_name)) {
        ob_end_clean();
        echo 'Error: invalid filename';
        exit;
    }

    // –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    $target_path = $upload_dir . $safe_name;

    // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï –§–ê–ô–õ–ê –ù–ê –°–ï–†–í–ï–† ====================
    // move_uploaded_file() –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏:
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ HTTP POST (–∑–∞—â–∏—Ç–∞)
    // 2. –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç —Ñ–∞–π–ª –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
    if (move_uploaded_file($_FILES['content']['tmp_name'], $target_path)) {
        // –£–°–ü–ï–•: —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω
        
        // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
        echo '<!DOCTYPE html>';
        echo '<html>';
        echo '<head>';
        echo '<meta charset="UTF-8">';
        echo '<title>File Uploaded</title>';
        echo '</head>';
        echo '<body>';
        echo '<h2>‚úÖ File Uploaded Successfully!</h2>';
        
        // realpath() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        $full_path = realpath($target_path);
        echo '<p><strong>Full Path:</strong><br>';
        echo htmlspecialchars($full_path) . '</p>';
        
        // filesize() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö
        $file_size = filesize($target_path);
        echo '<p><strong>File Size:</strong> ' . $file_size . ' bytes</p>';
        
        // –°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
        echo '<p><a href="index.html">üì§ Upload Another File</a></p>';
        echo '</body>';
        echo '</html>';
    } else {
        // –û–®–ò–ë–ö–ê: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª
        
        echo '<!DOCTYPE html>';
        echo '<html>';
        echo '<head>';
        echo '<meta charset="UTF-8">';
        echo '<title>Error</title>';
        echo '</head>';
        echo '<body>';
        echo '<h2 style="color: red;">‚ùå File Save Error</h2>';
        echo '<p>Possible reasons:</p>';
        echo '<ul>';
        echo '<li>No write permission to folder ' . htmlspecialchars($upload_dir) . '</li>';
        echo '<li>Disk space full</li>';
        echo '<li>File system error</li>';
        echo '</ul>';
        echo '<p><a href="index.html">‚Ü©Ô∏è Back to Upload Form</a></p>';
        echo '</body>';
        echo '</html>';
    }

    // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –í–ï–°–¨ –ù–ê–ö–û–ü–õ–ï–ù–ù–´–ô –í–´–í–û–î
    ob_end_flush();
?>

